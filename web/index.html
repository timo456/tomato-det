<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tomato Detector</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif; }
    body { margin:0; background:#0b1220; color:#e6edf7; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 28px 16px 60px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 18px; padding: 18px; backdrop-filter: blur(10px); }
    header { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 16px; }
    h1 { font-size: 22px; margin: 0; letter-spacing: .2px; }
    .sub { opacity:.8; font-size: 13px; line-height: 1.4; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 360px 1fr; } }

    .drop {
      border: 2px dashed rgba(255,255,255,0.25);
      border-radius: 16px; padding: 16px; text-align:center;
      transition: .15s ease;
    }
    .drop.drag { border-color: rgba(102, 220, 255, 0.9); background: rgba(102,220,255,0.08); }
    .btn { cursor:pointer; border:0; border-radius: 12px; padding: 10px 12px; background: #2f80ff; color:white; font-weight:600; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    .row { display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-top: 10px; }
    label { font-size: 13px; opacity: .9; }
    input[type="range"] { width: 100%; }

    .viewer { position: relative; border-radius: 16px; overflow:hidden; border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.25); }
    canvas { width: 100%; height: auto; display:block; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); font-size: 12px; opacity: .95; }
    .meta { display:flex; flex-wrap:wrap; gap: 10px; margin-top: 12px; }
    .muted { opacity:.75; }
    .err { color:#ffb4b4; margin-top: 10px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ğŸ… Smart Tomato Detection</h1>
        <div class="sub">FastAPI + YOLOv8ï½œæ‹–æ›³åœ–ç‰‡æˆ–é¸æ“‡æª”æ¡ˆï¼Œä¸Šå‚³å¾Œè‡ªå‹•æ¡†å‡ºç•ªèŒ„ã€‚</div>
      </div>
      <a class="pill" href="/docs" target="_blank" rel="noreferrer">Open API Docs</a>
    </header>

    <div class="grid">
      <div class="card">
        <div id="drop" class="drop">
          <div style="font-size:14px; font-weight:650;">æ‹–æ›³åœ–ç‰‡åˆ°é€™è£¡</div>
          <div class="sub muted" style="margin-top:6px;">æ”¯æ´ JPG / PNG</div>
          <div style="margin-top:12px;">
            <input id="file" type="file" accept="image/*" style="display:none;">
            <button id="pick" class="btn">é¸æ“‡åœ–ç‰‡</button>
          </div>
        </div>

        <div class="row">
          <label>conf: <span id="confVal">0.10</span></label>
        </div>
        <input id="conf" type="range" min="0" max="1" step="0.01" value="0.10" />

        <div class="row">
          <label>iou: <span id="iouVal">0.70</span></label>
        </div>
        <input id="iou" type="range" min="0" max="1" step="0.01" value="0.70" />

        <div class="row">
          <label>max_det</label>
          <span class="pill" id="maxDetVal">300</span>
        </div>
        <input id="maxDet" type="range" min="1" max="500" step="1" value="300" />

        <div class="row" style="margin-top:14px;">
          <button id="run" class="btn" disabled>é–‹å§‹åµæ¸¬</button>
          <span class="sub muted" id="status">å°šæœªé¸æ“‡åœ–ç‰‡</span>
        </div>

        <div class="err" id="err"></div>
      </div>

      <div class="card">
        <div class="viewer">
          <canvas id="cv"></canvas>
        </div>
        <div class="meta" id="meta"></div>
      </div>
    </div>
  </div>

<script>
  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('file');
  const pickBtn = document.getElementById('pick');
  const runBtn = document.getElementById('run');
  const statusEl = document.getElementById('status');
  const errEl = document.getElementById('err');

  const conf = document.getElementById('conf');
  const iou = document.getElementById('iou');
  const maxDet = document.getElementById('maxDet');
  const confVal = document.getElementById('confVal');
  const iouVal = document.getElementById('iouVal');
  const maxDetVal = document.getElementById('maxDetVal');

  const canvas = document.getElementById('cv');
  const ctx = canvas.getContext('2d');
  const meta = document.getElementById('meta');

  let currentFile = null;
  let img = new Image();

  function setErr(msg){ errEl.textContent = msg || ""; }
  function pill(text){ const d=document.createElement('div'); d.className='pill'; d.textContent=text; return d; }

  function updateSliderUI(){
    confVal.textContent = Number(conf.value).toFixed(2);
    iouVal.textContent = Number(iou.value).toFixed(2);
    maxDetVal.textContent = String(maxDet.value);
  }
  conf.addEventListener('input', updateSliderUI);
  iou.addEventListener('input', updateSliderUI);
  maxDet.addEventListener('input', updateSliderUI);
  updateSliderUI();

  function drawPreview(){
    if(!img.src) return;
    // è®“ canvas è·ŸåŸåœ–åŒå°ºå¯¸ï¼Œæ¡†æ‰æº–
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;
    ctx.drawImage(img, 0, 0);
  }

  function loadFile(f){
    currentFile = f;
    setErr("");
    statusEl.textContent = "å·²é¸æ“‡åœ–ç‰‡ï¼ŒæŒ‰ã€Œé–‹å§‹åµæ¸¬ã€";
    runBtn.disabled = false;
    const url = URL.createObjectURL(f);
    img.onload = () => { drawPreview(); URL.revokeObjectURL(url); };
    img.src = url;
  }

  pickBtn.onclick = () => fileInput.click();
  fileInput.onchange = (e) => {
    const f = e.target.files?.[0];
    if(f) loadFile(f);
  };

  // drag & drop
  drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
  drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
  drop.addEventListener('drop', (e)=>{
    e.preventDefault(); drop.classList.remove('drag');
    const f = e.dataTransfer.files?.[0];
    if(f) loadFile(f);
  });

  async function runDetect(){
    setErr("");
    statusEl.textContent = "åµæ¸¬ä¸­â€¦";
    runBtn.disabled = true;
    meta.innerHTML = "";

    try{
      const fd = new FormData();
      fd.append('file', currentFile);

      const url = `/detect?conf=${encodeURIComponent(conf.value)}&iou=${encodeURIComponent(iou.value)}&max_det=${encodeURIComponent(maxDet.value)}`;
      const res = await fetch(url, { method:"POST", body: fd });
      const data = await res.json();

      if(!res.ok || data.error){
        throw new Error(data.error || ("HTTP " + res.status));
      }

      // é‡ç•«åŸåœ–
      drawPreview();

      // ç•«æ¡†ï¼ˆç°¡å–®ç™½æ¡†ï¼Œä½ è¦æ›´ç¾æˆ‘ä¹Ÿèƒ½å¹«ä½ åŠ æ¨£å¼ï¼‰
      (data.detections || []).forEach(d => {
        ctx.lineWidth = Math.max(2, canvas.width * 0.002);
        ctx.strokeStyle = "rgba(102,220,255,0.95)";
        ctx.strokeRect(d.x1, d.y1, d.x2-d.x1, d.y2-d.y1);

        const label = `${d.class} ${(d.score*100).toFixed(1)}%`;
        ctx.font = `${Math.max(14, canvas.width*0.018)}px sans-serif`;
        const tw = ctx.measureText(label).width;
        const th = Math.max(18, canvas.width*0.022);
        ctx.fillStyle = "rgba(0,0,0,0.55)";
        ctx.fillRect(d.x1, Math.max(0, d.y1-th), tw+10, th);
        ctx.fillStyle = "white";
        ctx.fillText(label, d.x1+5, d.y1-6);
      });

      meta.appendChild(pill(`count: ${data.count}`));
      meta.appendChild(pill(`inference: ${Number(data.inference_ms).toFixed(1)} ms`));
      meta.appendChild(pill(`conf: ${Number(data.conf).toFixed(2)}`));
      meta.appendChild(pill(`iou: ${Number(data.iou).toFixed(2)}`));

      statusEl.textContent = "å®Œæˆ âœ…";
    }catch(err){
      setErr(String(err));
      statusEl.textContent = "å¤±æ•— âŒ";
    }finally{
      runBtn.disabled = false;
    }
  }

  runBtn.onclick = runDetect;
</script>
</body>
</html>

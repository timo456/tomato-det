<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tomato Detector</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans TC", sans-serif; }
    body { margin:0; background:#0b1220; color:#e6edf7; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 28px 16px 60px; }
    .card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); border-radius: 18px; padding: 18px; backdrop-filter: blur(10px); }
    header { display:flex; align-items:center; justify-content:space-between; gap: 12px; margin-bottom: 16px; }
    h1 { font-size: 22px; margin: 0; letter-spacing: .2px; }
    .sub { opacity:.8; font-size: 13px; line-height: 1.4; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 360px 1fr; } }

    .drop { border: 2px dashed rgba(255,255,255,0.25); border-radius: 16px; padding: 16px; text-align:center; transition: .15s ease; }
    .drop.drag { border-color: rgba(102, 220, 255, 0.9); background: rgba(102,220,255,0.08); }
    .btn { cursor:pointer; border:0; border-radius: 12px; padding: 10px 12px; background: #2f80ff; color:white; font-weight:600; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    .row { display:flex; align-items:center; justify-content:space-between; gap: 10px; margin-top: 10px; }
    label { font-size: 13px; opacity: .9; }
    input[type="range"] { width: 100%; }

    .viewer { position: relative; border-radius: 16px; overflow:hidden; border:1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.25); }
    canvas { width: 100%; height: auto; display:block; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding: 6px 10px; border-radius: 999px; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.12); font-size: 12px; opacity: .95; }
    .meta { display:flex; flex-wrap:wrap; gap: 10px; margin-top: 12px; }
    .muted { opacity:.75; }
    .err { color:#ffb4b4; margin-top: 10px; white-space: pre-wrap; }

    .sectionTitle { margin-top: 14px; font-size: 13px; opacity: .85; letter-spacing:.2px; }
    .box { margin-top: 8px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.05); border-radius: 14px; padding: 12px; }
    .warn { margin: 6px 0 0; padding-left: 18px; opacity:.92; }
    .warn li { margin: 4px 0; }
    .barWrap { height: 10px; background: rgba(255,255,255,0.10); border-radius: 999px; overflow:hidden; border:1px solid rgba(255,255,255,0.10); }
    .bar { height: 100%; width: 0%; background: rgba(102,220,255,0.95); }
    .trendCanvas { width: 100%; height: 160px; display:block; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ğŸ… Smart Tomato Monitoring</h1>
        <div class="sub">FastAPI + YOLOv8ï½œåµæ¸¬ç•ªèŒ„ã€å½±åƒå“è³ªæé†’ã€æˆç†Ÿåº¦èˆ‡æ¡æ”¶å»ºè­°ã€è¶¨å‹¢ç´€éŒ„ã€‚</div>
      </div>
      <a class="pill" href="/docs" target="_blank" rel="noreferrer">Open API Docs</a>
    </header>

    <div class="grid">
      <div class="card">
        <div id="drop" class="drop">
          <div style="font-size:14px; font-weight:650;">æ‹–æ›³åœ–ç‰‡åˆ°é€™è£¡</div>
          <div class="sub muted" style="margin-top:6px;">æ”¯æ´ JPG / PNG</div>
          <div style="margin-top:12px;">
            <input id="file" type="file" accept="image/*" style="display:none;">
            <button id="pick" class="btn">é¸æ“‡åœ–ç‰‡</button>
          </div>
        </div>

        <div class="row">
          <label>conf: <span id="confVal">0.10</span></label>
          <span class="sub muted" title="ä½ å¾Œç«¯ç›®å‰ FORCE_DEFAULT_PARAMS=Trueï¼Œæ‰€ä»¥æœ€å¾Œæœƒä»¥å¾Œç«¯å›å‚³ç‚ºæº–">ä»¥å¾Œç«¯ç‚ºæº–</span>
        </div>
        <input id="conf" type="range" min="0" max="1" step="0.01" value="0.10" />

        <div class="row">
          <label>iou: <span id="iouVal">0.70</span></label>
        </div>
        <input id="iou" type="range" min="0" max="1" step="0.01" value="0.70" />

        <div class="row">
          <label>max_det</label>
          <span class="pill" id="maxDetVal">300</span>
        </div>
        <input id="maxDet" type="range" min="1" max="500" step="1" value="300" />

        <div class="row" style="margin-top:14px;">
          <button id="run" class="btn" disabled>é–‹å§‹åµæ¸¬</button>
          <span class="sub muted" id="status">å°šæœªé¸æ“‡åœ–ç‰‡</span>
        </div>

        <div class="err" id="err"></div>

        <!-- âœ… æ–°å¢ï¼šå“è³ªèˆ‡æ¡æ”¶å»ºè­° -->
        <div class="sectionTitle">å“è³ªæé†’</div>
        <div class="box">
          <div class="row" style="margin-top:0;">
            <div class="pill">quality_score: <b id="qScore">-</b></div>
            <div class="pill muted">blur_var: <span id="blurVar">-</span></div>
            <div class="pill muted">brightness: <span id="brightness">-</span></div>
          </div>
          <div class="barWrap" style="margin-top:10px;">
            <div class="bar" id="qBar"></div>
          </div>
          <ul class="warn" id="warnList"></ul>
        </div>

        <div class="sectionTitle">æ¡æ”¶å»ºè­°</div>
        <div class="box">
          <div class="pill" style="margin-bottom:10px;">ğŸ“Œ <span id="harvest">-</span></div>
          <div class="meta" id="maturityMeta"></div>
          <div class="sub muted" style="margin-top:8px;">ï¼ˆä»¥é¡è‰²æ¯”ä¾‹åšæˆç†Ÿåº¦ proxyï¼šripe/turning/unripeï¼‰</div>
        </div>

        <div class="sectionTitle">æœ€è¿‘è¶¨å‹¢ï¼ˆæœ€è¿‘ 30 ç­†ï¼‰</div>
        <div class="box">
          <canvas id="trend" class="trendCanvas"></canvas>
          <div class="sub muted" id="trendHint" style="margin-top:8px;">å°šæœªæœ‰æ­·å²è³‡æ–™</div>
        </div>
      </div>

      <div class="card">
        <div class="viewer">
          <canvas id="cv"></canvas>
        </div>
        <div class="meta" id="meta"></div>
      </div>
    </div>
  </div>

<script>
  const drop = document.getElementById('drop');
  const fileInput = document.getElementById('file');
  const pickBtn = document.getElementById('pick');
  const runBtn = document.getElementById('run');
  const statusEl = document.getElementById('status');
  const errEl = document.getElementById('err');

  const conf = document.getElementById('conf');
  const iou = document.getElementById('iou');
  const maxDet = document.getElementById('maxDet');
  const confVal = document.getElementById('confVal');
  const iouVal = document.getElementById('iouVal');
  const maxDetVal = document.getElementById('maxDetVal');

  const canvas = document.getElementById('cv');
  const ctx = canvas.getContext('2d');
  const meta = document.getElementById('meta');

  // æ–°å¢ UI
  const qScore = document.getElementById('qScore');
  const blurVar = document.getElementById('blurVar');
  const brightness = document.getElementById('brightness');
  const qBar = document.getElementById('qBar');
  const warnList = document.getElementById('warnList');

  const harvest = document.getElementById('harvest');
  const maturityMeta = document.getElementById('maturityMeta');

  const trend = document.getElementById('trend');
  const trendCtx = trend.getContext('2d');
  const trendHint = document.getElementById('trendHint');

  let currentFile = null;
  let img = new Image();

  function setErr(msg){ errEl.textContent = msg || ""; }

  function pill(text){
    const d=document.createElement('div');
    d.className='pill';
    d.textContent=text;
    return d;
  }

  function updateSliderUI(){
    confVal.textContent = Number(conf.value).toFixed(2);
    iouVal.textContent = Number(iou.value).toFixed(2);
    maxDetVal.textContent = String(maxDet.value);
  }
  conf.addEventListener('input', updateSliderUI);
  iou.addEventListener('input', updateSliderUI);
  maxDet.addEventListener('input', updateSliderUI);
  updateSliderUI();

  function drawPreview(){
    if(!img.src) return;
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;
    ctx.drawImage(img, 0, 0);
  }

  function loadFile(f){
    currentFile = f;
    setErr("");
    statusEl.textContent = "å·²é¸æ“‡åœ–ç‰‡ï¼ŒæŒ‰ã€Œé–‹å§‹åµæ¸¬ã€";
    runBtn.disabled = false;
    const url = URL.createObjectURL(f);
    img.onload = () => { drawPreview(); URL.revokeObjectURL(url); };
    img.src = url;
  }

  pickBtn.onclick = () => fileInput.click();
  fileInput.onchange = (e) => {
    const f = e.target.files?.[0];
    if(f) loadFile(f);
  };

  drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('drag'); });
  drop.addEventListener('dragleave', ()=> drop.classList.remove('drag'));
  drop.addEventListener('drop', (e)=>{
    e.preventDefault(); drop.classList.remove('drag');
    const f = e.dataTransfer.files?.[0];
    if(f) loadFile(f);
  });

  function renderQuality(data){
    const q = data.quality || {};
    const score = (q.quality_score ?? null);
    qScore.textContent = (score === null) ? "-" : Number(score).toFixed(0);
    blurVar.textContent = (q.blur_var === undefined) ? "-" : Number(q.blur_var).toFixed(1);
    brightness.textContent = (q.brightness === undefined) ? "-" : Number(q.brightness).toFixed(1);

    const pct = (score === null) ? 0 : Math.max(0, Math.min(100, Number(score)));
    qBar.style.width = pct + "%";

    warnList.innerHTML = "";
    const warns = q.warnings || [];
    if(warns.length === 0){
      const li = document.createElement('li');
      li.textContent = "æœªåµæ¸¬åˆ°æ˜é¡¯å“è³ªå•é¡Œ";
      warnList.appendChild(li);
    }else{
      warns.forEach(w=>{
        const li=document.createElement('li');
        li.textContent = w;
        warnList.appendChild(li);
      });
    }
  }

  function renderMaturity(data){
    const m = data.maturity_summary || {};
    harvest.textContent = m.harvest_suggestion || "-";

    maturityMeta.innerHTML = "";
    if(m.ripe !== undefined) maturityMeta.appendChild(pill(`ripe: ${m.ripe}`));
    if(m.turning !== undefined) maturityMeta.appendChild(pill(`turning: ${m.turning}`));
    if(m.unripe !== undefined) maturityMeta.appendChild(pill(`unripe: ${m.unripe}`));
    if(m.unknown !== undefined) maturityMeta.appendChild(pill(`unknown: ${m.unknown}`));
  }

  function drawTrend(records){
    // resize canvas (retina)
    const cssW = trend.clientWidth;
    const cssH = 160;
    trend.width = Math.floor(cssW * devicePixelRatio);
    trend.height = Math.floor(cssH * devicePixelRatio);
    trendCtx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);

    trendCtx.clearRect(0,0,cssW,cssH);

    if(!records || records.length < 2){
      trendHint.textContent = "æ­·å²è³‡æ–™ä¸è¶³ï¼ˆè‡³å°‘åµæ¸¬ 2 æ¬¡ï¼‰";
      return;
    }
    trendHint.textContent = "count è¶¨å‹¢ï¼ˆè¶Šé«˜ä»£è¡¨ç•«é¢ä¸­ç•ªèŒ„è¶Šå¤šï¼‰";

    const counts = records.map(r => Number(r.count ?? 0));
    const maxV = Math.max(...counts, 1);
    const minV = Math.min(...counts, 0);

    const pad = 14;
    const W = cssW, H = cssH;
    const xStep = (W - pad*2) / (counts.length - 1);
    const yMap = (v) => {
      if(maxV === minV) return H/2;
      const t = (v - minV) / (maxV - minV);
      return (H - pad) - t * (H - pad*2);
    };

    // grid line
    trendCtx.globalAlpha = 0.35;
    trendCtx.strokeStyle = "white";
    trendCtx.lineWidth = 1;
    trendCtx.beginPath();
    trendCtx.moveTo(pad, H-pad);
    trendCtx.lineTo(W-pad, H-pad);
    trendCtx.stroke();
    trendCtx.globalAlpha = 1;

    // line
    trendCtx.strokeStyle = "rgba(102,220,255,0.95)";
    trendCtx.lineWidth = 2;
    trendCtx.beginPath();
    counts.forEach((v,i)=>{
      const x = pad + xStep*i;
      const y = yMap(v);
      if(i===0) trendCtx.moveTo(x,y);
      else trendCtx.lineTo(x,y);
    });
    trendCtx.stroke();

    // dots
    trendCtx.fillStyle = "rgba(102,220,255,0.95)";
    counts.forEach((v,i)=>{
      const x = pad + xStep*i;
      const y = yMap(v);
      trendCtx.beginPath();
      trendCtx.arc(x,y,3,0,Math.PI*2);
      trendCtx.fill();
    });

    // labels
    trendCtx.fillStyle = "rgba(255,255,255,0.85)";
    trendCtx.font = "12px sans-serif";
    trendCtx.fillText(`min ${minV}`, pad, pad);
    trendCtx.fillText(`max ${maxV}`, pad, pad+16);
  }

  async function refreshHistory(){
    try{
      const res = await fetch("/history?limit=30");
      const records = await res.json();
      drawTrend(records);
    }catch(e){
      trendHint.textContent = "ç„¡æ³•è®€å– /historyï¼ˆéƒ¨ç½²ç’°å¢ƒå¯èƒ½é‡ç½®æª”æ¡ˆå±¤ï¼‰";
    }
  }

  async function runDetect(){
    setErr("");
    statusEl.textContent = "åµæ¸¬ä¸­â€¦";
    runBtn.disabled = true;
    meta.innerHTML = "";

    try{
      const fd = new FormData();
      fd.append('file', currentFile);

      const url = `/detect?conf=${encodeURIComponent(conf.value)}&iou=${encodeURIComponent(iou.value)}&max_det=${encodeURIComponent(maxDet.value)}`;
      const res = await fetch(url, { method:"POST", body: fd });
      const data = await res.json();

      if(!res.ok || data.error){
        throw new Error(data.error || ("HTTP " + res.status));
      }

      // é‡ç•«åŸåœ–
      drawPreview();

      // ç•«æ¡† + æˆç†Ÿåº¦é¡è‰²ï¼ˆripe/turning/unripeï¼‰
      (data.detections || []).forEach(d => {
        ctx.lineWidth = Math.max(2, canvas.width * 0.002);

        const m = d.maturity || "unknown";
        if(m === "ripe") ctx.strokeStyle = "rgba(255,90,90,0.95)";
        else if(m === "turning") ctx.strokeStyle = "rgba(255,200,90,0.95)";
        else if(m === "unripe") ctx.strokeStyle = "rgba(120,255,160,0.95)";
        else ctx.strokeStyle = "rgba(102,220,255,0.95)";

        ctx.strokeRect(d.x1, d.y1, d.x2-d.x1, d.y2-d.y1);

        const label = `${d.class} ${(d.score*100).toFixed(1)}% â€¢ ${m}`;
        ctx.font = `${Math.max(14, canvas.width*0.018)}px sans-serif`;
        const tw = ctx.measureText(label).width;
        const th = Math.max(18, canvas.width*0.022);
        ctx.fillStyle = "rgba(0,0,0,0.55)";
        ctx.fillRect(d.x1, Math.max(0, d.y1-th), tw+10, th);
        ctx.fillStyle = "white";
        ctx.fillText(label, d.x1+5, d.y1-6);
      });

      meta.appendChild(pill(`count: ${data.count}`));
      meta.appendChild(pill(`inference: ${Number(data.inference_ms).toFixed(1)} ms`));
      meta.appendChild(pill(`conf(used): ${Number(data.conf).toFixed(2)}`));
      meta.appendChild(pill(`iou(used): ${Number(data.iou).toFixed(2)}`));

      // âœ… æ–°å¢å€å¡Šæ¸²æŸ“
      renderQuality(data);
      renderMaturity(data);

      // âœ… æ›´æ–°è¶¨å‹¢
      await refreshHistory();

      statusEl.textContent = "å®Œæˆ âœ…";
    }catch(err){
      setErr(String(err));
      statusEl.textContent = "å¤±æ•— âŒ";
    }finally{
      runBtn.disabled = false;
    }
  }

  runBtn.onclick = runDetect;

  // é€²é é¢å…ˆç•«ä¸€æ¬¡è¶¨å‹¢ï¼ˆå¦‚æœæœ‰æ­·å²ï¼‰
  refreshHistory();
</script>
</body>
</html>
